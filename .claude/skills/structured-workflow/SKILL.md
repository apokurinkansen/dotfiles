---
name: structured-workflow
description: リサーチ・計画・実装の3段階で複雑なタスクを構造的に進めるワークフロー。計画段階ではアノテーションサイクル（ユーザーがインラインコメント → Claude が反映を繰り返す）で品質を担保する。「/structured-workflow」「構造的に進めたい」「リサーチしてから計画を立てて」「しっかり調べてから実装して」「段階的に進めたい」で使用。コード開発、設計、ドキュメント作成、調査分析など、あらゆる複雑なタスクに対応。
---

# Structured Workflow

リサーチ → 計画 → 実装の3段階で複雑なタスクを進めるワークフロー。各段階でユーザーの承認を得てから次に進む。計画段階の**アノテーションサイクル**（ユーザーのインラインコメントを反復的に反映）が中核。

## ワークフロー全体像

```
Stage 0: スコーピング → [ユーザー承認]
Stage 1: リサーチ   → research.md 作成 → [ユーザーレビュー・承認]
Stage 2: プランニング → plan.md 作成 → [アノテーションサイクル] → [ユーザー承認]
Stage 3: 実装       → plan.md の TODO 消化 → [ユーザーレビュー]
```

**ガードレール:** 各ステージのユーザー承認なしに次のステージへ進まない。特に「計画承認前の実装着手」は厳禁。

## 初回オファー

ユーザーに構造化ワークフローを提案する。

1. 4 つのステージを簡潔に説明する
2. タスクの複雑度に対してこのワークフローが適切か判断を仰ぐ
3. ユーザーが受け入れたら Stage 0 へ進む。辞退したらフリーフォームで対応する

## Stage 0: スコーピング

**目的:** タスクの範囲・制約・成功基準を明確にする。

### プロセス

1. ユーザーのタスク説明を聞く
2. 以下を明確化する質問を 3-5 問する:
   - 最終的なゴール・成果物は何か
   - 対象範囲（何を含み、何を含まないか）
   - 制約条件（技術的制約、時間、既存システムとの整合性）
   - 成功基準（何をもって完了とするか）
   - 優先順位（複数の要件がある場合）
3. ユーザーの回答をもとにスコープを 1 段落で要約する

### ゲート

スコープ要約をユーザーに提示し、合意を得る。合意が得られたら Stage 1 へ進む。

## Stage 1: リサーチ

**目的:** タスクに関連するドメイン・コードベース・コンテキストを深く調査し、research.md にまとめる。

### プロセス

1. スコープに基づき、調査すべき領域を特定してユーザーに共有する
2. 深い調査を実行する:
   - コードベース: 関連ファイルを徹底的に読み、依存関係・パターン・制約を把握する
   - ドメイン: 関連する概念・用語・ベストプラクティスを整理する
   - 既存実装: 類似の実装やパターンを探す
3. 調査プロセスをリアルタイムに報告する（何を見つけたか、何がまだ不明か）
4. 調査結果を作業ディレクトリの `research.md` に書き出す（作業ディレクトリについては「ファイル管理」セクション参照）

### research.md の構成

```markdown
# リサーチ: [タスク名]

## 調査範囲
[何を調査したか]

## 調査結果
### [領域1]
[詳細な所見。表面的でなく、具体的な実装の詳細・制約・特殊ケースを含める]

### [領域2]
...

## 重要な発見・注意点
[実装に影響する重要な制約、エッジケース、リスク]

## 未解決の疑問
[調査では解決できなかった点]
```

**品質基準:** 表面的な概要ではなく、実装判断に必要な具体的詳細を含めること。「深く」「詳細に」「特殊ケースも含めて」を意識する。

### ゲート

research.md をユーザーに提示し、レビューを依頼する:

1. 調査結果に誤りや不足がないか確認を求める
2. 未解決の疑問について追加情報がないか尋ねる
3. ユーザーが調査完了と判断したら Stage 2 へ進む

## Stage 2: プランニング

**目的:** 詳細な実装計画を作成し、アノテーションサイクルで磨き上げる。

### プロセス

#### Step 1: 初期計画の作成

research.md をもとに作業ディレクトリの `plan.md` を作成する。

```markdown
# 計画: [タスク名]

## 概要
[何をどう実装するかの要約]

## 方針
[選択したアプローチとその理由。検討した代替案があれば簡潔に記載]

## 詳細設計
### [フェーズ/セクション 1]
[具体的な手順。コードタスクならコードスニペット・変更対象ファイルを含める]
[ドキュメントタスクなら構成案・要点を含める]

### [フェーズ/セクション 2]
...

## 考慮事項
[トレードオフ、リスク、将来の拡張への影響]

## TODO
- [ ] [フェーズ1: タスク名]
  - [ ] [個別タスク1]
  - [ ] [個別タスク2]
- [ ] [フェーズ2: タスク名]
  - [ ] ...
```

**重要:** 計画には実行可能なレベルの具体性を持たせる。コードタスクならコードスニペット、設計タスクなら具体的な構成例を含める。

#### Step 2: アノテーションサイクル

**これがこのワークフローの中核プロセス。**

1. plan.md をユーザーに提示し、レビューを依頼する
2. ユーザーに以下を説明する:
   - plan.md に直接インラインコメント（メモ・修正指示）を書き込んでよい
   - 短い指示で構わない（例: 「ここは不要」「ORM を使う」「キャッシュなし」）
   - 構造の変更、アプローチの却下、ドメイン知識の注入、何でも書き込める
3. ユーザーがコメントを追加したら:
   - 「plan.md にコメントを確認しました。すべてのコメントに対応して計画を更新します」と伝える
   - すべてのコメントに対応し、plan.md を更新する
   - **絶対に実装を開始しない**
   - 更新した plan.md をユーザーに再提示する
4. ユーザーが満足するまで 2-3 を繰り返す（通常 1-6 回）

**アノテーションサイクル中のガードレール:**
- ユーザーのコメントをすべて漏れなく対応する
- 対応内容を箇条書きで報告する
- 「実装してよいか」とは聞かない。ユーザーから明示的な承認があるまで計画の修正を続ける

#### Step 3: TODO リストの最終化

アノテーションサイクル完了後、plan.md の TODO セクションが計画と整合しているか確認し、必要に応じて更新する。

### ゲート

ユーザーから計画の最終承認を得る。「この計画で実装を進めてよいか」と明示的に確認する。承認されたら Stage 3 へ進む。

## Stage 3: 実装

**目的:** 承認された計画に従って実装を実行する。

### プロセス

1. plan.md の TODO リストに沿って実装を進める
2. 各タスク完了時に plan.md の該当 TODO にチェックを入れる (`- [x]`)
   - 子タスクをすべて完了したら、親（フェーズ）のチェックボックスも `- [x]` にする
3. 実装中の方針:
   - 計画にないことは実装しない
   - 不要なコメント・ドキュメントを追加しない
   - 問題が発生したら、計画を逸脱する前にユーザーに報告する
   - コードタスクの場合は型チェック・リント等を継続的に実行する
4. すべての TODO が完了するまで続ける

### 実装中のフィードバック対応

- ユーザーからの簡潔な修正指示に対応する（計画が明確なので短い指示で十分）
- 方向性が根本的に間違っている場合は、変更を戻してスコープを再設定する（無理に修正を重ねない）
- 既存パターンへの参照（「この部分は〇〇と同じ方式で」）に従う

### ゲート

全 TODO 完了後、ユーザーに最終レビューを依頼する:

1. plan.md の TODO がすべてチェック済みか確認する
2. 成果物をユーザーに提示する
3. 追加の修正が必要か確認する

## 運用ガイドライン

**トーン:**
- 各ステージで何をするか・なぜするかを簡潔に説明する
- 手続き的に進行し、過度な説明は避ける

**偏差への対応:**
- ユーザーがステージをスキップしたい場合: 理由を確認し、了承する
- リサーチが不要な場合（ユーザーが十分な知識を持つ場合）: Stage 1 をスキップ可
- 小さなタスクの場合: ワークフロー自体が過剰かもしれないことを伝える

**ファイル管理:**
- Stage 0 完了時に作業ディレクトリを作成する: `.claude/tmp/YYYYMMDD-{task-name}/`
  - `YYYYMMDD` は `date +%Y%m%d` で取得
  - `{task-name}` はスコーピングで決まったタスク名を kebab-case にしたもの（例: `20260215-doc-update-check`）
- research.md と plan.md はこの作業ディレクトリ内に作成する
- 過去のタスクの成果物は別ディレクトリに残るため、上書きの心配はない

**セッション管理:**
- 可能な限り、リサーチから実装まで1つのセッションで通す（コンテキスト維持のため）
- plan.md はコンテキスト圧縮後も参照できる永続的なアーティファクトとして機能する

## 参考

- [How I Use Claude Code](https://boristane.com/blog/how-i-use-claude-code/) - Boris Tane
